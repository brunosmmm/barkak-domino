{
  "author": {
    "email": "brunosmmm@gmail.com",
    "name": "Bruno Morais"
  },
  "data": {
    "branch": "main",
    "content": "# Fix Auto-Scaling and Layout Breaking Bugs\n\n## Summary\nFixed two critical bugs in `useChainLayout.ts` that caused tiles to go off-screen and layouts to break on resize.\n\n## Bug 1: Auto-Scaling Not Working\n**Problem:** Scale calculation only considered one arm of the snake, but the chain can have multiple rows stacking up.\n\n**Fix:** Added post-placement bounds checking (lines 252-301):\n1. After calculating all raw placements, compute actual bounding box of all tiles\n2. If bounding box exceeds container, calculate `fitScale = min(widthRatio, heightRatio)`\n3. Apply transformation to all placements: scale positions and dimensions by `fitScale`, center in container\n\n```typescript\n// Calculate actual bounding box\nlet minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\nfor (const p of rawPlacements) {\n  minX = Math.min(minX, p.position.x);\n  maxX = Math.max(maxX, p.position.x + p.renderWidth);\n  // ...\n}\n\n// Calculate fit scale\nlet fitScale = 1;\nif (contentWidth > availableW || contentHeight > availableH) {\n  fitScale = Math.min(availableW / contentWidth, availableH / contentHeight, 1);\n}\n\n// Apply to all placements\nconst placements = rawPlacements.map(p => ({\n  ...p,\n  position: { x: p.position.x * fitScale + offsetX, y: p.position.y * fitScale + offsetY },\n  renderWidth: p.renderWidth * fitScale,\n  renderHeight: p.renderHeight * fitScale,\n}));\n```\n\n## Bug 2: Layout Breaking on Resize\n**Problem:** When cache resets (container size change), only `board[0]` was positioned at center. But `board[0]` is the leftmost tile, not the first tile played. Middle tiles were never repositioned.\n\n**Fix:** Changed cache rebuild to:\n1. Find the CENTER tile (index = `floor((N-1)/2)`) - the first tile played\n2. Position it at container center\n3. Walk LEFT from center to rebuild all left-arm tiles\n4. Walk RIGHT from center to rebuild all right-arm tiles\n\n```typescript\nconst centerIndex = Math.floor((board.length - 1) / 2);\nconst centerTile = board[centerIndex];\n// Position center tile...\n\n// Rebuild left arm\nfor (let i = centerIndex - 1; i >= 0; i--) {\n  const result = placeNextTile(leftArm, ...);\n  positions.set(key, result.position);\n  leftArm = result.newArm;\n}\n\n// Rebuild right arm\nfor (let i = centerIndex + 1; i < board.length; i++) {\n  const result = placeNextTile(rightArm, ...);\n  positions.set(key, result.position);\n  rightArm = result.newArm;\n}\n```\n\n## Files Changed\n- `frontend/src/hooks/useChainLayout.ts` - Both bug fixes\n\n## Related Work\n- Previous attempt (ann_015812): Added adaptive tilesPerRow/Column but didn't fix core scaling issue\n- User correction identified that auto-scaling still wasn't working",
    "context": "Fixed bugs after user reported auto-scaling not working and layout still breaking",
    "repository_id": "github.com/brunosmmm/barkak-domino",
    "session_id": "20260129_214539_796f",
    "session_type": "Debugging",
    "title": "Fix Auto-Scaling and Layout Breaking Bugs"
  },
  "entity_id": "20260130_0208_fix-auto-scaling-and-layout-breaking-bugs",
  "lamport_clock": 74,
  "operation_id": "op_20260131_010445_2bf200c7",
  "operation_type": "checkpoint_save",
  "parent_operation": null,
  "timestamp": "2026-01-30T02:08:42.799924+00:00"
}